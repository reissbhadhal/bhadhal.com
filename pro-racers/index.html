<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Racers - Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --neon-red: #ff3300;
            --neon-orange: #ffaa00;
            --text-color: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Mobile Controls */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 40px;
            pointer-events: none;
            /* Let touches pass through to buttons */
        }

        .control-group {
            display: flex;
            gap: 20px;
            pointer-events: auto;
        }

        .btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 51, 0, 0.2);
            border: 2px solid var(--neon-red);
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            backdrop-filter: blur(5px);
        }

        .btn:active {
            background: var(--neon-red);
            color: #000;
        }

        /* Lobby UI */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            padding: 20px;
        }

        .back-link {
            display: inline-block;
            pointer-events: auto;
            color: var(--neon-orange);
            text-decoration: none;
            border: 1px solid var(--neon-orange);
            padding: 5px 15px;
            background: rgba(0, 0, 0, 0.5);
        }

        /* Desktop Only Tip */
        @media (min-width: 769px) {
            .mobile-controls {
                display: none;
            }
        }
    </style>
</head>

<body>
    <canvas id="gameCanvas"></canvas>

    <div class="ui-overlay">
        <!-- SCREEN 1: INTRO -->
        <div id="introScreen"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100vh; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10;">
            <h1
                style="color: var(--neon-orange); font-size: 4rem; text-shadow: 0 0 20px var(--neon-orange); margin-bottom: 20px;">
                PRO RACERS</h1>
            <p style="color: #fff; margin-bottom: 40px; letter-spacing: 2px;">ONLINE 3D RACING LEAGUE</p>
            <button id="btnStartEngine"
                style="background: transparent; border: 3px solid var(--neon-red); color: var(--neon-red); font-size: 2rem; padding: 20px 60px; font-family: inherit; font-weight: bold; cursor: pointer; text-shadow: 0 0 10px var(--neon-red); box-shadow: 0 0 20px rgba(255, 51, 0, 0.3);">
                START ENGINE
            </button>
        </div>

        <!-- SCREEN 2: GARAGE / SELECTION -->
        <div id="garageScreen"
            style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.85); flex-direction: column; justify-content: center; align-items: center; z-index: 9;">
            <h2 style="color: #fff; margin-bottom: 30px;">GARAGE SETUP</h2>

            <!-- Name Input -->
            <div style="margin-bottom: 30px; text-align: center;">
                <label style="display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px;">DRIVER NAME</label>
                <input type="text" id="playerName" placeholder="ENTER NAME" maxlength="10"
                    style="background: rgba(0,0,0,0.5); border: 2px solid var(--neon-orange); color: #fff; padding: 15px; font-family: inherit; font-size: 1.5rem; text-align: center; text-transform: uppercase; width: 300px;">
            </div>

            <!-- Selection UI -->
            <div style="display: flex; gap: 20px; margin-bottom: 40px;">
                <button id="btnCar"
                    style="background: #222; border: 1px solid #fff; color: #fff; padding: 20px; min-width: 200px; cursor: pointer; text-align: center;">
                    <span style="display:block; color:#888; font-size:0.8rem">VEHICLE</span>
                    <span id="carName" style="color:#00ffff; font-size: 1.2rem; font-weight:bold;">CYAN SPEEDSTER</span>
                </button>
                <button id="btnMap"
                    style="background: #222; border: 1px solid #fff; color: #fff; padding: 20px; min-width: 200px; cursor: pointer; text-align: center;">
                    <span style="display:block; color:#888; font-size:0.8rem">TRACK</span>
                    <span id="mapName" style="color:#ff00ff; font-size: 1.2rem; font-weight:bold;">NEON OVAL</span>
                </button>
            </div>

            <!-- Play Button -->
            <button id="btnPlay"
                style="background: var(--neon-orange); border: none; color: #000; font-size: 1.5rem; padding: 20px 80px; font-family: inherit; font-weight: 900; cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%);">
                PLAY RACE
            </button>

            <p style="margin-top:20px; color:#666; font-size:0.9rem;">MULTIPLAYER: TO JOIN A FRIEND, START A RACE FIRST
                THEN USE PIT STOP</p>
        </div>

        <!-- SCREEN 3: HUD (In Game) -->
        <div id="hudScreen" style="display: none; width: 100%; height: 100%;">
            <!-- Top Bar -->
            <div style="position: absolute; top: 20px; left: 20px; display: flex; gap: 20px; align-items: start;">
                <a href="/" class="back-link" style="opacity: 0.5;">‚Üê EXIT</a>
                <button id="btnPitStop" class="back-link" style="background: #333; border-color: #fff;">PIT STOP
                    üõ†Ô∏è</button>
                <button id="btnCam" class="back-link" style="background: #333; border-color: #00ffff;">CAM:
                    OUTSIDE</button>
            </div>

            <p id="lobbyStatus"
                style="position: absolute; top: 20px; width: 100%; text-align: center; color: #fff; text-shadow: 0 0 5px #fff; font-size: 1.2em; pointer-events: none;">
            </p>
        </div>

        <!-- Hidden Lobby Menu (Pop up from Pit Stop) -->
        <div id="lobbyMenu"
            style="display: none; background: rgba(0,0,0,0.9); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 40px; border: 2px solid var(--neon-orange); text-align: center; border-radius: 10px; z-index: 20;">
            <h2 style="color: #fff; margin-bottom: 20px;">MULTIPLAYER MENU</h2>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                <button id="btnCreate"
                    style="background: rgba(0, 100, 255, 0.6); border: 3px solid #00ffff; color: #fff; font-family: inherit; font-size: 1.2rem; padding: 15px 30px; font-weight: bold; cursor: pointer;">
                    CREATE RACE
                </button>
                <button id="btnJoin"
                    style="background: rgba(255, 100, 0, 0.6); border: 3px solid #ff3300; color: #fff; font-family: inherit; font-size: 1.2rem; padding: 15px 30px; font-weight: bold; cursor: pointer;">
                    JOIN RACE
                </button>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboardPanel" style="margin-top: 20px; text-align: left; background: #111; padding: 10px;">
                <h3 style="color: var(--neon-orange); border-bottom: 1px solid #555;">LEADERBOARD</h3>
                <div id="leaderboardList" style="font-size: 0.8em; max-height: 150px; overflow-y: auto;">Loading...
                </div>
            </div>

            <button id="btnClosePit"
                style="margin-top: 20px; background: transparent; border: 1px solid #666; color: #aaa; padding: 10px 20px; cursor: pointer;">CLOSE</button>
        </div>
    </div>

    <script>
        // --- SCREEN FLOW LOGIC ---
        const introScreen = document.getElementById('introScreen');
        const garageScreen = document.getElementById('garageScreen');
        const hudScreen = document.getElementById('hudScreen');
        const lobbyMenu = document.getElementById('lobbyMenu');

        // 1. Start Engine -> Go to Garage
        document.getElementById('btnStartEngine').onclick = () => {
            introScreen.style.display = 'none';
            garageScreen.style.display = 'flex';

            // Try to load name
            const storedName = localStorage.getItem('racerName');
            if (storedName) {
                document.getElementById('playerName').value = storedName;
                document.getElementById('btnPlay').innerText = "PLAY AS " + storedName;
            }
        };

        const nameInput = document.getElementById('playerName');
        nameInput.oninput = () => {
            const val = nameInput.value.toUpperCase();
            document.getElementById('btnPlay').innerText = val ? "PLAY AS " + val : "PLAY RACE";
        };

        // 2. Play Button -> Start Game
        document.getElementById('btnPlay').onclick = () => {
            const name = nameInput.value.toUpperCase() || 'ANONYMOUS';
            localStorage.setItem('racerName', name);
            localStorage.setItem('racerNameTime', Date.now().toString());

            if (window.game) {
                window.game.playerName = name;
                window.game.startGameLoop(); // Create this method to actually unpause/start
            }

            garageScreen.style.display = 'none';
            hudScreen.style.display = 'block';
        };

        // Pit Stop Actions
        document.getElementById('btnPitStop').onclick = () => {
            lobbyMenu.style.display = 'block';
            if (window.game && window.game.network) window.game.network.fetchLeaderboard();
        };
        document.getElementById('btnClosePit').onclick = () => {
            lobbyMenu.style.display = 'none';
        };

        // Camera Toggle
        document.getElementById('btnCam').onclick = () => {
            if (window.game) {
                const mode = window.game.toggleCamera();
                document.getElementById('btnCam').innerText = "CAM: " + mode;
            }
        };

        // Multiplayer Buttons (Existing logic mostly)
        document.getElementById('btnCreate').onclick = async () => {
            if (window.game && window.game.network) {
                document.getElementById('lobbyStatus').innerText = "Creating Lobby...";
                const name = window.game.playerName;
                const id = await window.game.network.createLobby(name);
                if (id) {
                    document.getElementById('lobbyStatus').innerHTML = `LOBBY ID: <span style="color:#00ffff; font-size:1.5em">${id}</span>`;
                    lobbyMenu.style.display = 'none'; // Close menu to race
                }
            }
        };

        document.getElementById('btnJoin').onclick = async () => {
            const id = prompt("Enter Lobby ID:");
            if (id && window.game && window.game.network) {
                const name = window.game.playerName;
                const success = await window.game.network.joinLobby(id, name);
                if (success) {
                    document.getElementById('lobbyStatus').innerText = "CONNECTED! RACING!";
                    lobbyMenu.style.display = 'none';
                } else {
                    document.getElementById('lobbyStatus').innerText = "Failed to join.";
                }
            }
        };
    </script>

    <div class="mobile-controls">
        <div class="control-group">
            <div class="btn" id="btnLeft">‚Üê</div>
            <div class="btn" id="btnRight">‚Üí</div>
        </div>
        <div class="control-group">
            <div class="btn" id="btnBrake" style="border-color: #ffaa00;">‚Üì</div>
            <div class="btn" id="btnGas">‚Üë</div>
        </div>
    </div>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBEK728sxamdYrWyTmv-DacTEf5cs8Qfyc",
            authDomain: "spaceinvaders-ace73.firebaseapp.com",
            projectId: "spaceinvaders-ace73",
            storageBucket: "spaceinvaders-ace73.firebasestorage.app",
            messagingSenderId: "1055474779844",
            appId: "1:1055474779844:web:5033a5fc644f2437deeb91",
            measurementId: "G-L200ZZ9YXC"
        };
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
    </script>
    <script src="RaceNetworkManager.js"></script>
    <script src="game.js"></script>
</body>

</html>