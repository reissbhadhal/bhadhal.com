<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Racers - Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --neon-red: #ff3300;
            --neon-orange: #ffaa00;
            --text-color: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
            height: 100vh;
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Mobile Controls */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 40px;
            pointer-events: none;
            /* Let touches pass through to buttons */
        }

        .control-group {
            display: flex;
            gap: 20px;
            pointer-events: auto;
        }

        .btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 51, 0, 0.2);
            border: 2px solid var(--neon-red);
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            backdrop-filter: blur(5px);
        }

        .btn:active {
            background: var(--neon-red);
            color: #000;
        }

        /* Lobby UI */
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            padding: 20px;
        }

        .back-link {
            display: inline-block;
            pointer-events: auto;
            color: var(--neon-orange);
            text-decoration: none;
            border: 1px solid var(--neon-orange);
            padding: 5px 15px;
            background: rgba(0, 0, 0, 0.5);
        }

        /* Desktop Only Tip */
        @media (min-width: 769px) {
            .mobile-controls {
                display: none;
            }
        }
    </style>
</head>

<body>
    <canvas id="gameCanvas"></canvas>

    <div class="ui-overlay">
        <!-- Persistent HUD -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <a href="/" class="back-link" style="opacity: 0.5;">‚Üê EXIT</a>
            <button id="btnPitStop" class="back-link" style="opacity: 0.8; background: #333; border-color: #fff;">PIT
                STOP üõ†Ô∏è</button>
        </div>

        <!-- Hidden Lobby Menu -->
        <div id="lobbyMenu"
            style="display: none; background: rgba(0,0,0,0.9); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 40px; border: 2px solid var(--neon-orange); text-align: center; border-radius: 10px;">
            <h2 style="color: #fff; margin-bottom: 20px;">PIT STOP MENU</h2>

            <!-- Name Input -->
            <input type="text" id="playerName" placeholder="ENTER RACER NAME" maxlength="10"
                style="background: rgba(0,0,0,0.8); border: 2px solid var(--neon-orange); color: #fff; padding: 15px; font-family: inherit; font-size: 1.2rem; text-align: center; text-transform: uppercase; margin-bottom: 20px; width: 100%;">

            <!-- Lobby Buttons -->
            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                <button id="btnCreate"
                    style="background: rgba(0, 100, 255, 0.6); border: 3px solid #00ffff; color: #fff; font-family: inherit; font-size: 1.2rem; padding: 15px 30px; font-weight: bold; cursor: pointer; text-shadow: 0 0 5px #00ffff;">
                    CREATE RACE
                </button>
                <button id="btnJoin"
                    style="background: rgba(255, 100, 0, 0.6); border: 3px solid #ff3300; color: #fff; font-family: inherit; font-size: 1.2rem; padding: 15px 30px; font-weight: bold; cursor: pointer; text-shadow: 0 0 5px #ff3300;">
                    JOIN RACE
                </button>
            </div>

            <button id="btnClosePit"
                style="margin-top: 20px; background: transparent; border: 1px solid #666; color: #aaa; padding: 10px 20px; cursor: pointer;">RESUME
                RACE</button>
        </div>

        <!-- Leaderboard (Keep visible or move to menu? Let's keep it mini or hide it. User said removing terminal screen. Let's hide it and show in Pit Stop or separate toggle. Actually, let's keep it visible but small at bottom left maybe? Or inside Pit Stop. Let's put it in Pit Stop to be clean) -->
        <div id="leaderboardPanel" style="display: none; margin-top: 20px; text-align: left;">
            <h3 style="color: var(--neon-orange); border-bottom: 1px solid #555;">LEADERBOARD</h3>
            <div id="leaderboardList" style="font-size: 0.8em; max-height: 150px; overflow-y: auto;">Loading...</div>
        </div>

        <p id="lobbyStatus"
            style="margin-top: 10px; color: #fff; text-shadow: 0 0 5px #fff; font-size: 1.2em; text-align: center;"></p>
    </div>

    <!-- Lobby Logic -->
    <script>
        // Toggle Pit Stop
        const lobbyMenu = document.getElementById('lobbyMenu');
        const leaderboardPanel = document.getElementById('leaderboardPanel');

        document.getElementById('btnPitStop').onclick = () => {
            lobbyMenu.style.display = 'block';
            leaderboardPanel.style.display = 'block'; // Show leaderboard in menu
            // Fetch leaderboard when menu opens
            if (window.game && window.game.network) {
                window.game.network.fetchLeaderboard();
            }
        };

        document.getElementById('btnClosePit').onclick = () => {
            lobbyMenu.style.display = 'none';
        };

        // Load Name with 7-Day Expiry
        const nameInput = document.getElementById('playerName');
        const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;

        const storedName = localStorage.getItem('racerName');
        const storedTime = localStorage.getItem('racerNameTime');
        const now = Date.now();

        if (storedName && storedTime && (now - parseInt(storedTime) < ONE_WEEK_MS)) {
            // Valid and not expired
            nameInput.value = storedName;
            // Set it in game immediately so leaderboard works for single player
            // We need to wait for game to be ready, or set it on window.onload
            window.addEventListener('load', () => {
                if (window.game) window.game.playerName = storedName;
            });
        } else {
            // Expired or missing - clear it so they are asked again
            localStorage.removeItem('racerName');
            localStorage.removeItem('racerNameTime');
            nameInput.value = "";
        }

        const saveName = () => {
            const name = nameInput.value.toUpperCase() || 'ANONYMOUS';
            localStorage.setItem('racerName', name);
            localStorage.setItem('racerNameTime', Date.now().toString());
            window.game.playerName = name;
            return name;
        };

        document.getElementById('btnCreate').onclick = async () => {
            const name = saveName();

            document.getElementById('lobbyStatus').innerText = "Creating Lobby...";
            const id = await window.game.network.createLobby(name);
            if (id) {
                document.getElementById('lobbyStatus').innerHTML = `LOBBY ID: <span style="color:#00ffff; font-size:1.5em">${id}</span><br>Waiting for opponent...`;
                document.getElementById('btnCreate').style.display = 'none';
                document.getElementById('btnJoin').style.display = 'none';
                document.getElementById('playerName').style.display = 'none';
            }
        };

        document.getElementById('btnJoin').onclick = async () => {
            const name = saveName();

            const id = prompt("Enter Lobby ID:");
            if (id) {
                document.getElementById('lobbyStatus').innerText = "Joining...";
                const success = await window.game.network.joinLobby(id, name);
                if (success) {
                    document.getElementById('lobbyStatus').innerText = "CONNECTED! RACING!";
                    document.getElementById('btnCreate').style.display = 'none';
                    document.getElementById('btnJoin').style.display = 'none';
                    document.getElementById('playerName').style.display = 'none';
                } else {
                    document.getElementById('lobbyStatus').innerText = "Failed to join. Check ID.";
                }
            }
        };

        // Init Leaderboard
        window.addEventListener('load', async () => {
            // We will implement this in RaceNetworkManager
            if (window.game && window.game.network) {
                await window.game.network.fetchLeaderboard();
            }
        });
    </script>

    <div class="mobile-controls">
        <div class="control-group">
            <div class="btn" id="btnLeft">‚Üê</div>
            <div class="btn" id="btnRight">‚Üí</div>
        </div>
        <div class="control-group">
            <div class="btn" id="btnBrake" style="border-color: #ffaa00;">‚Üì</div>
            <div class="btn" id="btnGas">‚Üë</div>
        </div>
    </div>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBEK728sxamdYrWyTmv-DacTEf5cs8Qfyc",
            authDomain: "spaceinvaders-ace73.firebaseapp.com",
            projectId: "spaceinvaders-ace73",
            storageBucket: "spaceinvaders-ace73.firebasestorage.app",
            messagingSenderId: "1055474779844",
            appId: "1:1055474779844:web:5033a5fc644f2437deeb91",
            measurementId: "G-L200ZZ9YXC"
        };
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
    </script>
    <script src="RaceNetworkManager.js"></script>
    <script src="game.js"></script>
</body>

</html>