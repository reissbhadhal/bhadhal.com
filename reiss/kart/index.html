<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pro Racers</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Racing+Sans+One&display=swap" rel="stylesheet">
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("Global Error: " + msg + "\nLine: " + line + "\nCol: " + col + "\nStack: " + (error ? error.stack : 'bg'));
            return false;
        };
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Racing Sans One', cursive;
        }

        canvas {
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 10;
        }

        #lap-counter {
            font-size: 2em;
            font-weight: bold;
            color: #FFD700;
        }

        #timer {
            font-size: 1.5em;
            color: #fff;
        }

        .speedometer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 2em;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 20;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            transition: opacity 0.5s;
        }

        #title-screen h1 {
            font-size: 4em;
            margin: 0 0 20px 0;
            font-family: 'Arial Black', sans-serif;
            font-style: italic;
            letter-spacing: -2px;
        }

        #start-btn {
            background: #fff;
            color: #ff6b6b;
            border: none;
            padding: 20px 40px;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        #start-btn:hover {
            transform: scale(1.05);
        }

        #start-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
    </style>
    <!-- Import map for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>
    <!-- PeerJS for Multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <div id="ui-layer">
        <!-- P1 HUD -->
        <div id="p1-hud" class="hud-panel" style="position:absolute; top:20px; left:20px;">
            <div id="p1-lap" class="lap-counter">LAP 1 / 3</div>
            <div id="p1-time" class="timer">00:00.00</div>
            <div id="p1-item" class="item-slot"
                style="margin-top:10px; width:60px; height:60px; border:3px solid #fff; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; font-size:30px;">
            </div>
            <div id="p1-pos" style="font-size:40px; color:#ffff00;">1st</div>
        </div>

        <!-- P2 HUD (Local Multiplayer) -->
        <div id="p2-hud" class="hud-panel"
            style="position:absolute; top:20px; right:20px; text-align:right; display:none;">
            <div id="p2-lap" class="lap-counter">LAP 1 / 3</div>
            <div id="p2-time" class="timer">00:00.00</div>
            <div style="display:flex; justify-content:flex-end;">
                <div id="p2-item" class="item-slot"
                    style="margin-top:10px; width:60px; height:60px; border:3px solid #fff; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; font-size:30px;">
                </div>
            </div>
            <div id="p2-pos" style="font-size:40px; color:#ffff00;">1st</div>
        </div>

        <!-- Mobile Controls (Touch) -->
        <div id="mobile-controls"
            style="display:none; position:absolute; bottom:20px; width:100%; pointer-events:none;">
            <!-- D-Pad Left -->
            <div style="position:absolute; left:20px; bottom:20px; width:150px; height:150px; pointer-events:auto;">
                <div id="btn-left" class="touch-btn"
                    style="position:absolute; left:0; top:40px; width:60px; height:60px; background:rgba(255,255,255,0.3); border-radius:50%; border:2px solid white;">
                    ‚óÄ</div>
                <div id="btn-right" class="touch-btn"
                    style="position:absolute; right:0; top:40px; width:60px; height:60px; background:rgba(255,255,255,0.3); border-radius:50%; border:2px solid white;">
                    ‚ñ∂</div>
            </div>

            <!-- Actions Right -->
            <div style="position:absolute; right:20px; bottom:20px; width:150px; height:150px; pointer-events:auto;">
                <div id="btn-gas" class="touch-btn"
                    style="position:absolute; right:0; top:0; width:70px; height:70px; background:rgba(0,255,0,0.3); border-radius:50%; border:2px solid #0f0; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                    A</div>
                <div id="btn-brake" class="touch-btn"
                    style="position:absolute; left:0; top:40px; width:50px; height:50px; background:rgba(255,0,0,0.3); border-radius:50%; border:2px solid #f00; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                    B</div>
                <div id="btn-item" class="touch-btn"
                    style="position:absolute; left:20px; top:-40px; width:60px; height:60px; background:rgba(255,255,0,0.3); border-radius:10px; border:2px solid #ff0; display:flex; align-items:center; justify-content:center; font-size:24px;">
                    üçÑ</div>
            </div>
        </div>
    </div>

    <div id="title-screen">
        <h1 style="font-size: 60px; text-shadow: 0 0 20px #ff00de;">REISS & ANAIA'S<br>RACING GAME</h1>

        <!-- Start Screen -->
        <div id="start-screen" class="options-container"
            style="background:rgba(0,0,0,0.8); text-align:center; padding:50px; border-radius:20px; border:2px solid #ff00de;">
            <h1 class="game-title">PRO RACERS</h1>
            <button id="engine-btn"
                style="font-size:2em; padding:20px 40px; background:linear-gradient(45deg, #ff00de, #00ffff); border:none; border-radius:10px; font-family:'Racing Sans One'; cursor:pointer; animation: pulse 1s infinite alternate;">START
                ENGINE</button>
        </div>

        <!-- Main Menu (4 Modes) -->
        <div id="main-menu" class="options-container"
            style="display:none; width:900px; grid-template-columns: 1fr 1fr; gap:20px; background:none; box-shadow:none; border:none;">
            <div class="mode-card" onclick="selectMode('gp')"
                style="background:#440044; padding:30px; border-radius:15px; cursor:pointer; border:2px solid #ff00de; text-align:center; transition:0.3s;">
                <div style="font-size:50px;">üèÜ</div>
                <h2>GRAND PRIX</h2>
                <p>Classic Racing vs CPU</p>
            </div>
            <div class="mode-card" onclick="selectMode('roam')"
                style="background:#004444; padding:30px; border-radius:15px; cursor:pointer; border:2px solid #00ffff; text-align:center; transition:0.3s;">
                <div style="font-size:50px;">üïäÔ∏è</div>
                <h2>FREE ROAM</h2>
                <p>Explore freely. No Rules.</p>
            </div>
            <div class="mode-card" onclick="selectMode('vs')"
                style="background:#444400; padding:30px; border-radius:15px; cursor:pointer; border:2px solid #ffff00; text-align:center; transition:0.3s;">
                <div style="font-size:50px;">‚öîÔ∏è</div>
                <h2>VS RACE</h2>
                <p>Custom Teams & Series</p>
            </div>
            <div class="mode-card" onclick="selectMode('battle')"
                style="background:#004400; padding:30px; border-radius:15px; cursor:pointer; border:2px solid #00ff00; text-align:center; transition:0.3s;">
                <div style="font-size:50px;">üí∞</div>
                <h2>BATTLE MODE</h2>
                <p>Coin Runners (4 Teams)</p>
            </div>
        </div>

        <!-- VS Settings Panel -->
        <div id="vs-settings" class="options-container" style="display:none; width:600px; text-align:center;">
            <h2>VS RACE SETTINGS</h2>

            <label>Teams:</label>
            <div class="setting-row">
                <button class="opt-btn" onclick="setVsOption('teams', 'none', this)">FFA</button>
                <button class="opt-btn" onclick="setVsOption('teams', '2', this)">2 Teams</button>
                <button class="opt-btn" onclick="setVsOption('teams', '4', this)">4 Teams</button>
            </div>

            <label>Difficulty:</label>
            <div class="setting-row">
                <button class="opt-btn" onclick="setVsOption('diff', 'easy', this)">50cc</button>
                <button class="opt-btn" onclick="setVsOption('diff', 'medium', this)">100cc</button>
                <button class="opt-btn" onclick="setVsOption('diff', 'hard', this)">150cc</button>
            </div>

            <label>Races:</label>
            <input type="range" min="1" max="12" value="4"
                oninput="document.getElementById('race-count-disp').innerText = this.value">
            <span id="race-count-disp" style="font-size:1.5em; color:#00ffff;">4</span> Races

            <br><br>
            <button class="action-btn" onclick="confirmVsSettings()">NEXT</button>
        </div>

        <!-- Battle Settings Panel -->
        <div id="battle-settings" class="options-container" style="display:none; width:600px; text-align:center;">
            <h2>BATTLE SETUP</h2>
            <p>Coin Runners - 4 Minutes</p>

            <label>Choose Your Team:</label>
            <div class="setting-row">
                <button class="opt-btn" style="border-color:red; color:red;" onclick="setBattleTeam('red', this)">RED
                    üî¥</button>
                <button class="opt-btn" style="border-color:blue; color:blue;"
                    onclick="setBattleTeam('blue', this)">BLUE üîµ</button>
                <button class="opt-btn" style="border-color:yellow; color:yellow;"
                    onclick="setBattleTeam('yellow', this)">YELLOW üü°</button>
                <button class="opt-btn" style="border-color:lime; color:lime;"
                    onclick="setBattleTeam('green', this)">GREEN üü¢</button>
            </div>

            <button class="action-btn" onclick="confirmBattleSettings()">START BATTLE</button>
        </div>

        <!-- Vehicle Select (Existing, reused) -->
        <div id="vehicle-select-panel" class="options-container" style="display:none; width: 600px;">
            <!-- ... content via JS or static ... -->
            <h3 style="margin:0 0 20px 0; color:#00ffff;">CHOOSE YOUR RIDE</h3>
            <div style="display:flex; justify-content:space-around; gap:20px; margin-bottom:20px;">
                <div class="vehicle-option" onclick="selectVehicle('car')"
                    style="background:#444; padding:20px; border-radius:10px; cursor:pointer; border:2px solid transparent; flex:1;">
                    <div style="font-size:60px;">üèéÔ∏è</div>
                    <h3>F1 RACER</h3>
                </div>
                <div class="vehicle-option" onclick="selectVehicle('bike')"
                    style="background:#444; padding:20px; border-radius:10px; cursor:pointer; border:2px solid transparent; flex:1;">
                    <div style="font-size:60px;">üèçÔ∏è</div>
                    <h3>MOTORBIKE</h3>
                </div>
            </div>
            <button id="next-to-char" class="action-btn" onclick="goToCharSelect()">NEXT</button>
        </div>



        <!-- Step 2: Character Select (Hidden initially) -->
        <div id="char-select-panel" class="options-container"
            style="display:none; background:rgba(0,0,0,0.8); padding:30px; border-radius:15px; text-align:center; width: 800px; border: 2px solid #ff00de; box-shadow: 0 0 30px rgba(255,0,222,0.3); max-height:80vh; overflow-y:auto;">
            <h3 style="margin:0 0 20px 0; color:#ff00de;">SELECT YOUR F1 TEAM</h3>

            <div id="char-grid-container" class="char-grid"
                style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:20px;">
                <!-- Filled by JS -->
            </div>

            <button id="next-to-map-flow" onclick="goToMapSelect()"
                style="width:100%; padding:15px; background:linear-gradient(45deg, #00ff00, #00ffff); color:black; font-weight:bold; border:none; border-radius:5px; cursor:pointer; font-size:1.2em; filter: grayscale(100%); pointer-events:none;">NEXT
                STEP</button>
        </div>

        <!-- 7. MAP SELECT PANEL -->
        <div id="map-select-panel" class="options-container"
            style="display:none; text-align:center; background:rgba(0,0,0,0.9); padding:30px; border-radius:15px; border: 2px solid #00ffff;">
            <h2 style="color:#00ffff; margin-top:0;">CHOOSE TRACK</h2>
            <div class="map-grid" style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;">
                <div class="map-card" onclick="selectMap('circuit', this)"
                    style="border:4px solid #00ffff; background:#004444; width:180px; padding:10px; border-radius:10px; cursor:pointer; transition:transform 0.1s;">
                    <div
                        style="width:100%; height:240px; background:url('maps.png') 0% 0% / 300% 100%; border-radius:5px;">
                    </div>
                    <div style="margin-top:10px; font-weight:bold; color:white;">MARIO CIRCUIT</div>
                </div>
                <div class="map-card" onclick="selectMap('rainbow', this)"
                    style="border:4px solid transparent; background:#222; width:180px; padding:10px; border-radius:10px; cursor:pointer; transition:transform 0.1s;">
                    <div
                        style="width:100%; height:240px; background:url('maps.png') 50% 0% / 300% 100%; border-radius:5px;">
                    </div>
                    <div style="margin-top:10px; font-weight:bold; color:white;">RAINBOW ROAD</div>
                </div>
                <div class="map-card" onclick="selectMap('bowser', this)"
                    style="border:4px solid transparent; background:#222; width:180px; padding:10px; border-radius:10px; cursor:pointer; transition:transform 0.1s;">
                    <div
                        style="width:100%; height:240px; background:url('maps.png') 100% 0% / 300% 100%; border-radius:5px;">
                    </div>
                    <div style="margin-top:10px; font-weight:bold; color:white;">BOWSER CASTLE</div>
                </div>
            </div>
            <button id="start-race-btn" class="menu-btn"
                style="margin-top:30px; width:100%; background:linear-gradient(45deg, #FFD700, #FFA500); color:black; font-size:1.5em; padding:20px; cursor:pointer; border:none; border-radius:10px; font-weight:900;">START
                RACE</button>
        </div>

        <script>
            // Global Config
            let gameConfig = {
                mode: 'gp',
                vehicle: 'car',
                char: 'mario',
                vsSettings: { teams: 'none', diff: 'medium', races: 4 },
                battleSettings: { team: 'red' }
            };

            // Helper to switch panels
            function showPanel(id) {
                document.querySelectorAll('.options-container').forEach(el => el.style.display = 'none');
                const target = document.getElementById(id);
                if (target) {
                    target.style.display = (id === 'main-menu') ? 'grid' : 'block';
                }
            }

            // 1. ENGINE START
            document.getElementById('engine-btn').addEventListener('click', () => {
                document.getElementById('start-screen').style.display = 'none';
                showPanel('main-menu');
            });

            // 2. MAIN MENU SEL
            window.selectMode = function (mode) {
                gameConfig.mode = mode;
                if (mode === 'gp' || mode === 'roam') {
                    showPanel('vehicle-select-panel');
                } else if (mode === 'vs') {
                    showPanel('vs-settings');
                } else if (mode === 'battle') {
                    showPanel('battle-settings');
                }
            };

            // 3. VS SETTINGS
            window.setVsOption = function (key, val, btn) {
                if (key === 'teams') gameConfig.vsSettings.teams = val;
                if (key === 'diff') gameConfig.vsSettings.diff = val;

                // Visual update
                btn.parentNode.querySelectorAll('.opt-btn').forEach(b => b.style.background = 'transparent');
                btn.style.background = '#00ffff';
            };

            window.confirmVsSettings = function () {
                const range = document.querySelector('input[type="range"]');
                if (range) gameConfig.vsSettings.races = parseInt(range.value);
                showPanel('vehicle-select-panel');
            };

            // 4. BATTLE SETTINGS
            window.setBattleTeam = function (team, btn) {
                gameConfig.battleSettings.team = team;
                btn.parentNode.querySelectorAll('.opt-btn').forEach(b => b.style.background = 'transparent');
                btn.style.background = '#444';
            };

            window.confirmBattleSettings = function () {
                showPanel('vehicle-select-panel');
            };

            // 5. VEHICLE SELECT
            window.selectVehicle = function (type) {
                gameConfig.vehicle = type;
                document.querySelectorAll('.vehicle-option').forEach(el => {
                    el.style.border = '2px solid transparent';
                    el.style.background = '#444';
                });
                if (event && event.currentTarget) {
                    event.currentTarget.style.border = '2px solid #00ffff';
                    event.currentTarget.style.background = '#004444';
                }

                const btn = document.getElementById('next-to-char');
                if (btn) {
                    btn.style.background = '#00ffff';
                    btn.style.color = 'black';
                    btn.style.pointerEvents = 'auto';
                }
            };

            window.goToCharSelect = function () {
                showPanel('char-select-panel');
            };

            // 6. CHARACTER GRID (Dynamic with Image)
            // Order matches the generated "mario_kart_grid_ordered" sprite sheet
            const chars = [
                // Row 1
                'mario', 'luigi', 'peach', 'daisy', 'rosalina', 'tanooki_mario',
                // Row 2
                'toad', 'yoshi', 'koopa', 'shyguy', 'lakitu', 'toadette',
                // Row 3 (Babies + Metal)
                'baby_mario', 'baby_luigi', 'baby_peach', 'baby_daisy', 'baby_rosalina', 'metal_mario',
                // Row 4 (Heavies)
                'pink_gold_peach', 'wario', 'waluigi', 'dk', 'bowser', 'dry_bones',
                // Row 5 (Koopalings/Bowser Jr)
                'bowser_jr', 'dry_bowser', 'lemmy', 'larry', 'wendy', 'ludwig',
                // Row 6 (More Koopalings + Guest)
                'iggy', 'roy', 'morton', 'inkling_girl', 'inkling_boy', 'link'
            ];

            const container = document.getElementById('char-grid-container');
            if (container) {
                container.innerHTML = '';

                chars.forEach((c, index) => {
                    const name = c.replace('_', ' ').toUpperCase();
                    // Map to 6x6 grid (36 slots)
                    // The image has 6 columns.
                    const col = index % 6;
                    const row = Math.floor(index / 6);

                    const div = document.createElement('div');
                    div.className = 'char-card';
                    div.dataset.char = c;
                    div.style.cssText = `background:#222; padding:5px; border-radius:10px; cursor:pointer; border:2px solid transparent; text-align:center; transition:transform 0.1s; display:flex; flex-direction:column; align-items:center;`;
                    div.onclick = () => selectChar(c);

                    const img = document.createElement('div');
                    img.style.cssText = `
                        width: 70px; height: 70px;
                        background-image: url('characters.png');
                        background-size: 600% 600%; 
                        background-position: ${col * 20}% ${row * 20}%;
                        border-radius: 5px;
                        margin-bottom: 5px;
                    `;

                    div.appendChild(img);
                    div.appendChild(document.createTextNode(name));
                    div.lastChild.style = "font-size:10px; font-weight:bold; color:white; margin-top:5px;";

                    container.appendChild(div);
                });
            }

            window.selectChar = function (char) {
                document.querySelectorAll('.char-card').forEach(c => {
                    c.style.borderColor = 'transparent';
                    c.style.background = '#222';
                    c.style.transform = 'scale(1)';
                });
                const selected = document.querySelector(`.char-card[data-char="${char}"]`);
                if (selected) {
                    selected.style.borderColor = '#00ffff';
                    selected.style.background = '#004444';
                    selected.style.transform = 'scale(1.05)';
                }
                gameConfig.char = char;

                const btn = document.getElementById('next-to-map-flow');
                if (btn) {
                    btn.style.filter = 'none';
                    btn.style.pointerEvents = 'auto';
                    btn.innerText = "CONTINUE WITH " + char.replace('_', ' ').toUpperCase();
                }
            };

            // --- MAP SELECTION LOGIC ---
            window.goToMapSelect = function () {
                showPanel('map-select-panel');
            };

            window.selectMap = function (mapId, el) {
                gameConfig.map = mapId;
                document.querySelectorAll('.map-card').forEach(c => {
                    c.style.borderColor = 'transparent';
                    c.style.background = '#222';
                    c.style.transform = 'scale(1.0)';
                });
                el.style.borderColor = '#00ffff';
                el.style.background = '#004444';
                el.style.transform = 'scale(1.05)';
            };

            // FINAL START
            const startBtn = document.getElementById('start-race-btn');
            if (startBtn) {
                startBtn.onclick = () => {
                    document.getElementById('title-screen').style.display = 'none';
                    document.getElementById('ui-layer').style.display = 'block';

                    window.CONFIG = {
                        playMode: 1,
                        difficulty: gameConfig.vsSettings.diff || 'medium',
                        totalLaps: gameConfig.mode === 'roam' ? 999 : (gameConfig.mode === 'battle' ? 999 : 3),
                        gameMode: gameConfig.mode,
                        mapId: gameConfig.map, // Pass Map ID
                        vsSettings: gameConfig.vsSettings,
                        battleSettings: gameConfig.battleSettings
                    };
                    window.selectedCharacter = gameConfig.char;
                    window.selectedVehicle = gameConfig.vehicle;

                    if (window.initGame) {
                        try {
                            window.initGame();
                        } catch (e) {
                            alert("Game Error: " + e.message + "\n" + e.stack);
                        }
                    } else {
                        alert("Game Engine not loaded yet! Please wait a moment and try again.");
                    }
                };
            }
        </script>
    </div>

    <script type="module" src="game.js"></script>
</body>

</html>